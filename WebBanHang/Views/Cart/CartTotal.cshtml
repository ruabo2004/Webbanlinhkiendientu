@model ShoppingCart
@{
    var customer = UserManager.CurrentCustomer;
    var subtotal = Model != null ? Model.GetTotal() : 0;
    long rankDiscount = 0;
    long couponDiscount = 0;
    string couponCode = "";
    long finalTotal = subtotal;
    
    // Rank discount
    if (customer != null && customer.MemberRank != null && customer.MemberRank.DiscountPercent > 0)
    {
        rankDiscount = (long)(subtotal * (decimal)customer.MemberRank.DiscountPercent / 100M);
    }
    
    // Coupon discount
    if (Session["CouponCode"] != null)
    {
        couponCode = Session["CouponCode"].ToString();
        if (Session["CouponDiscount"] != null)
        {
            couponDiscount = Convert.ToInt64(Session["CouponDiscount"]);
        }
    }
    
    finalTotal = subtotal - rankDiscount - couponDiscount;
    if (finalTotal < 0) 
    {
        finalTotal = 0;
    }
}

<table class="table table-bordered">
    <thead>
        <tr>
            <th>
                <div class="cart-sub-total">
                    Tạm tính: <span class="inner-left-md">@Html.FormatCurrency(subtotal) VNĐ</span>
                </div>
                
                @* Rank Discount *@
                @if (rankDiscount > 0 && customer != null && customer.MemberRank != null)
                {
                    var rank = customer.MemberRank;
                    var gradientColor = "";
                    switch (rank.RankID)
                    {
                        case 1:
                            gradientColor = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
                            break;
                        case 2:
                            gradientColor = "linear-gradient(135deg, #CD7F32 0%, #8B4513 100%)";
                            break;
                        case 3:
                            gradientColor = "linear-gradient(135deg, #C0C0C0 0%, #808080 100%)";
                            break;
                        case 4:
                            gradientColor = "linear-gradient(135deg, #FFD700 0%, #FFA500 100%)";
                            break;
                        case 5:
                            gradientColor = "linear-gradient(135deg, #00D4FF 0%, #0099CC 100%)";
                            break;
                        default:
                            gradientColor = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
                            break;
                    }
                    <div style="background: @gradientColor; padding: 12px 15px; border-radius: 8px; margin: 10px 0; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 13px; margin-bottom: 8px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                            <i class="@rank.GetIconClass()"></i> <strong>ƯU ĐÃI HẠNG @rank.RankName.ToUpper()</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px;">
                            <span>Giảm @rank.DiscountPercent%</span>
                            <strong style="font-size: 16px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">- @Html.FormatCurrency(rankDiscount) VNĐ</strong>
                        </div>
                    </div>
                }
                
                @* Coupon Form *@
                <div style="margin: 15px 0;">
                    @if (string.IsNullOrEmpty(couponCode))
                    {
                        <div class="input-group">
                            <input type="text" id="coupon-input" class="form-control" placeholder="Nhập mã giảm giá..." style="height: 40px;">
                            <span class="input-group-btn">
                                <button class="btn" id="btn-apply-coupon" type="button" style="height: 40px; background-color: #3498db; color: white; border-color: #3498db;">
                                    <i class="fa fa-tag"></i> Áp dụng
                                </button>
                            </span>
                        </div>
                        <div id="coupon-message" style="margin-top: 5px;"></div>
                    }
                    else
                    {
                        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 12px 15px; border-radius: 8px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 13px; margin-bottom: 5px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        <i class="fa fa-ticket"></i> <strong>MÃ GIẢM GIÁ: @couponCode</strong>
                                    </div>
                                    <div style="font-size: 16px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                                        - @Html.FormatCurrency(couponDiscount) VNĐ
                                    </div>
                                </div>
                                <button class="btn btn-sm" id="btn-remove-coupon" type="button" style="padding: 5px 10px; background-color: #3498db; color: white; border-color: #3498db;">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                    }
                </div>
                
                <div class="cart-grand-total" style="color: #333;">
                    Thành tiền: <span class="inner-left-md" style="color: #dc3545 !important; font-weight: bold; font-size: 18px;">@Html.FormatCurrency(finalTotal) VNĐ</span>
                    @if (rankDiscount > 0 || couponDiscount > 0)
                    {
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            <del>@Html.FormatCurrency(subtotal) VNĐ</del>
                        </div>
                    }
                </div>
            </th>
        </tr>
    </thead><!-- /thead -->
    <tbody>
        <tr>
            <td>
                <div class="cart-checkout-btn" style="text-align:center;">
                    <a href="@Url.Action("Shipping","Checkout")" type="submit" class="btn" style="background-color: #3498db; color: white; border-color: #3498db; padding: 12px 30px; font-size: 16px; font-weight: bold;">THANH TOÁN NGAY</a>
                </div>
            </td>
        </tr>
    </tbody><!-- /tbody -->
</table><!-- /table -->
